import { Appear } from 'mdx-deck'
import Layout from './Layout'
import { Trace } from './Trace';

export { default as theme } from './theme'

export default Layout

# De React 16.4 √† <s>16.7</s> 16.9
## nouveaut√©s, _hooks_, ‚Ä¶ et moi et moi et moi ‚ÄΩ

React Nantes n¬∞ 4 ‚Äî Jeudi 29 novembre 2018

Yann Picard de Muller

Dev Fullstack JS, Beekast

[@YannPdeM](https://twitter.com/YannPdeM),  [github.com/YannPdeM](https://github.com/YannPdeM)

[CC-BY-NC-SA-4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/)

---
export default Layout

# React ?
<ul>
<Appear>
<li>lib UI</li>
<li>DOM virtuel : conciliation</li>
<li>Versionnement s√©mantique</li>
<li>Gros effort de compatibilit√©</li>
<li><i>Fiber</i></li>
<li>Composants</li>
</Appear>
</ul>

---
export default Layout

# Lib UI
<ul>
<Appear>
<li>Pas un <i>Framework</i></li>
<li>Ne g√®re pas Ajax, LocalStorage, ‚Ä¶ pour nous</li>
<li><code>redux</code>, <code>knockout</code>, <code>backbone</code>, ‚Ä¶</li>
</Appear>
</ul>

---
export default Layout

# Versionnement s√©mantique

<ul>
<Appear>
<li><code>X.Y.Z</code> (ex : <code>v16.6.3</code>)</li>
<li><code>Z</code> : corrections</li>
<li><code>Y</code> : nouvelles fonctionnalit√©s (+ parfois des corrections)</li>
<li><code>X</code> : changement qui casse le code existant (ex : les m√©thodes d√©pr√©ci√©es de cycle de vie vont √™tre renomm√©es en <code>unstable_AncienNom</code>)</li>
</Appear>
</ul>

---
export default Layout

# _Fiber_ : <s>_async_</s> _concurrent_ React

* multi-t√¢che coop√©ratif
* Coroutines
* Scheduler

---
export default Layout

# Composants (1/4)

* `render(props)`
* cycle de vie

---
export default Layout

# Composants (2/4) : le _render_

<ul>
<Appear>
<li><code>render(props)</code> -> <code>render(state, props, context)</code></li>
<li><i>state</i> : l‚Äô√©tat du composant (ex. : pli√©/d√©pli√© pour un accord√©on)</li>
<li><i>props</i> : le param√©trage du composant</li>
<li><i>context</i> :<ul>
    <li>API exp√©rimentale et d√©pr√©ci√©e</li>
    <li>API React 16</li>
    </ul></li>
</Appear>
</ul>

---
export default Layout

# Composants (3a/4) : le cycle de vie

## Montage
* `constructor`
* <s>`componentWillMount`</s>
* `getDerivedStateFromProps(nextProps, prevState)`
* `render`
* conciliation
* `componentDidMount`

---
export default Layout

# Composants (3b/4) : le cycle de vie

## Mise-√†-jour
* <s>`componentWillReceiveProps(nextProps)`</s>
* `getDerivedStateFromProps(nextProps, prevState)`
* `shouldComponentUpdate(nextProps, nextState, nextContext)`
* <s>`componentWillUpdate(nextProps, nextState)`</s>
* conciliation
* `getSnapshotBeforeUpdate(prevProps, prevState)`
* `componentDidUpdate(prevProps, prevState, prevContext)`

---
export default Layout

# Composants (3c/4) : le cycle de vie

## Cas sp√©cial
* `componentDidCatch(errorString, errorInfo)`

## D√©montage
* `componentWillUnmount`
---
export default Layout

# Composants (4a/4) : types de composants
## ‚ÄúFunction _Components_‚Äù
### parfois appel√©s √† tort ‚Äú_Stateless Components_‚Äù
```jsx
const MonComposant = (props) => <p>Hello {props.name}!</p>
```

---
export default Layout

# Composants (4b/4) : types de composants
## `React.Component`
```jsx
class MonComposant extends React.Component {
  constructor(props) {
    super(props);
    this.state = {
      greetings: `Hello ${props.name}!`
    };
  }
  shouldComponentUpdate(nextProps, nextState, nextContext) {
    return nextProps === this.props && nextState === this.state;
  }
  render () {
    return <p>{this.state.greetings}</p>
  }
}
```

---
export default Layout

# Composants (4c/4) : types de composants
## `React.PureComponent`
```jsx
class MonComposant extends React.Component {
  constructor(props) {
    super(props);
    this.state = {
      greetings: `Hello ${props.name}!`
    };
  }
  shouldComponentUpdate(nextProps, nextState, nextContext) {
    return nextProps === this.props && nextState === this.state;
  }
  render () {
    return <p>{this.state.greetings}</p>
  }
}
```
Attention les mises-√†-jour des _props_ ne sont pas faites pour les sous-composants, il faut donc qu‚Äôils soient eux-m√™me des PureComponents

---
export default Layout

# Et moi demain ‚ÄΩ

Petite proposition :

1. plan de risque<ul><li>`create-react-class` & _mixins_ __versus__ int√©gration de nouveaux</li><li>partie plus faciles √† migrer ?</li><li>tests de non-r√©gression ?</li></ul>
2. Passer √† React 16 si ce n‚Äôest pas d√©j√† fait ;-)
3. Plan de migration pour les m√©thodes d√©pr√©ci√©es (viser 2020 sans avoir √† utiliser les `unstable_`)
4. Utiliser `<StricMode>` pour d√©couvrir les points faibles de l‚Äôapplication

---
export default Layout

# React 16.4

<ol>
<Appear>
<li>_Pointer Events_<ul><li>une interface unifi√©e pour la souris, le toucher, les stylets, ‚Ä¶</li><li>pas encore support√© par Apple/Safari üò≠</li></ul></li>
<li>une correction pour `getDerivedStateFromProps` qui est maintenant appel√©e √† chaque `render` quelle qu‚Äôen soit la cause</li>
<li>une mise-√†-jour de s√©curit√© pour le rendu c√¥t√© serveur en ao√ªt</li>
</Appear>
</ol>

---
export default Layout

# React 16.4

```jsx
const props = {
  userProvidedData: '></div><script>alert("hello world!")</script>'
};
const element = <div {...props} />;
const html = ReactDOMServer.renderToString(element);
```

Avant :
`<div ></div><script>alert("hello world!")</script>`

Apr√®s :
`<div></div>`

---
export default Layout

# Et moi demain ‚ÄΩ
* Est-ce que j‚Äôutilise d√©j√† les _Pointer Events_ ? Avec un Polyfill ? L‚Äôai-je bien test√© (chrome sur iPhone, Safari sur Mac, ‚Ä¶) ?
* Ai-je un plan d‚Äôaction pour quand Apple aura fini de les impl√©menter ? Comment serais-je au courant ?
* `getDerivedStateFromProps` √©tant fiable, me suis-je d√©barass√© des usages de `componentWillReceiveProps` ?

---
export default Layout

# React 16.5
* API exp√©rimentale + outil de trace
```jsx
import { unstable_trace as trace } from "scheduler/tracing";

class MyComponent extends Component {
  constructor(props) {
    super(props);
    this.onClick.bind(this);
  }
  
  onClick () {
    trace('Login button click', performance.now(), () => {
      this.setState({ isLoggingIn: true });
    });
  };

  render () {
    return (
      <button onClick={onClick}>Click!</button>
    );
  } 
}
```

---
export default Layout

# Et moi demain ‚ÄΩ
* se faire la main sur des POCs
* √âtudier ma/mes applis 

---
export default Layout

# React 16.6
* memo
* React.lazy()
* `<Suspense />`
* `static contextType`
* `getDerivedStateFromError()`
* nouvelles d√©pr√©ciations en `<StrictMode />`

---
export default Layout

# React 16.6 : memo
```jsx
import React, { memo } from 'react';
const composantSyst√©matiquementRecalcul√© = (props) => <p>Hello {props.name}!</p>
const composantMemo√Øs√© = memo(
    composantSyst√©matiquementRecalcul√©,
    (prevProps, nextProps) => prevProps.name === nextProps.name
);
```

Composant d‚Äôordre sup√©rieur

React r√©utilise autant que possible le rendu tant que les props n‚Äôont pas chang√©.

‚ö†Ô∏è le fonctionnement est l‚Äôinverse de shouldComponent update :
* On dit quand il faut r√©utiliser le changement
* React peut d√©cider d‚Äôen refaire un rendu quand m√™me

---
export default Layout

# React 16.6 : React.lazy et `<Suspense />`
```jsx
import React, { lazy, Suspense } from 'react';
const ComposantDynamiquementImporte = lazy(() => import('./ProchainePage'));
const MonComposant = () => (<Suspense fallback={<div>Chargement‚Ä¶</div>}>
  <ComposantDynamiquementImporte />
</Suspense>);
```

L‚Äôimport dynamique peut √™tre fait par WebPack

Suspense met en pause le rendu du composant, et fourni une alternative en attendant que le composant soit pr√™t


---
export default Layout

# React 16.6 : `<Suspense />`
```jsx
import React, { lazy, Suspense } from 'react';
const UnComposantRapidementCharge = lazy(() => import('./ComposantRapide'));
const UnComposantLentementCharge = lazy(() => import('./ComposantLent'));
const MonComposant = () => (<Suspense fallback={<div>Chargement‚Ä¶</div>}>
  <UnComposantRapidementCharge />
  <Suspense fallback={<div>Chargement‚Ä¶</div>}>
    <UnComposantLentementCharge />
  </Suspense>
</Suspense>);

```

En mettant des `<Suspense />` dans des `<Suspense />` on peut g√©rer le chargement progressif d‚Äôune page.

---
export default Layout

# React 16.6 : static contextType

```jsx
const MonContexte = React.createContext();

class MonComposant extends React.Component {
  static contextType = MyContext;
  componentDidMount () {
    const value = this.context;
    ‚Ä¶
  }
  
  render () {
    const value = this.context;
    ‚Ä¶
  }
}
```

---
export default Layout

# React 16.6 : getDerivedStateFromError()
Permet d‚Äôavoir un rendu de pr√™t au render

```jsx
class MonComposant extends React.Component {
  constructor (props) {
    super(props);
    this.state = {
      hasError: false
    };
  }

  static getDerivedStateFromError (error) {
    return {
      hasError: false
    };
  }
  
  componentDidCatch(error, info) {
    console.error(error, info);
  }
  
  render () {
    return this.state.hasError
      ? <h1>Ayeuh</h1>
      : this.props.children;
  }
}
```

‚ö†Ô∏è `componentDidCatch` n‚Äôest plus suppos√© g√©rer que les effets de bords et ne plus appeler `this.setState()`

---
export default Layout

# React 16.6 : nouvelles d√©pr√©ciations
* `ReactDOM.findDOMNode()` -> utiliser les _refs_
* l‚Äôancienne API de contexte, ‚ö†Ô∏è certaines libs (ex : `react-redux`) l‚Äôutilisent beaucoup et sont en cours de migration

---
export default Layout

# Et moi demain ‚ÄΩ
* Y a-t-il des endroits o√π l‚Äôemploi de `React.memo` ferait du bien √† mes utilisateurs ?
* Est-ce que j‚Äôutilise d√©j√† les imports dynamiques ? Si oui, lesquels profiteraient de `React.lazy` ?
* Et si je rempla√ßait `react-loader` et consorts par `React.lazy` + `<Suspense />` ?
* Si l‚Äôacc√®s au contexte me liait √† l‚Äôancienne API, qu‚Äôen est-il maintenant ?
* Mon code est-il √† jour par rapport aux d√©pr√©ciations ? Et celui des d√©pendances ? La migration est-elle au moins en cours ? Si non, faut-il un coup de main ? Un plan B ?

---
export default Layout

# React 16.7 : Q1 2019
## _Hooks_
* useState
* useEffect
* r√®gles des _hooks_
* quelques autres _hooks_ 

---
export default Layout

# React 16.7 : hooks
## `useState`

```jsx
const ExempleUseState = () => {
  const [checkedIn, setCheckedIn] = useState(false);
  const [count, setCount] = useState(0);
 
  return {
    <div>
      {checkedIn ? (
        <button onClick={() => setCheckedIn(true)>check-in</button>
      ) : (
        <button onClick={() => setCount(count + 1)>Vous avez cliqu√© {count} fois</button>
      )}
    </div>
  };
};
 ```

‚ö†Ô∏è contrairement √† `React.Component.setState()` ici les √©tats ne sont pas fusionn√©s

üòÉ on peut avoir diff√©rents √©tats en parall√®le

---
export default Layout

# React 16.7 : hooks
## `useEffect`

```jsx
const log = () => console.log(Date.now());

const ExempleUseEffect = () => {
  useEffect(() => {
    const intervalHandle = setInterval(log, 5000);
    return () => clearInterval(intervalHandle);
  });
 
  return {
    <div>useEffect</div>
  };
};
 ```

---
export default Layout

# React 16.7 : hooks
## r√®gles

* Attention √† l‚Äôordre
* Seulement dans un composant React ou un autre _hook_
* Pas dans des `if`, boucles, ‚Ä¶

---
export default Layout

# Quelques autres hooks
* `useContext(MonContexte)`
* `useReducer`
* `useMemo`
* `useRef`
* `useLayoutEffect` ‚ö†Ô∏è 

```jsx
const useOldSetState = (initialState) => {
  const [state, setState] = useReducer(
    (state, newState) => ({...state, ...newState}),
    initialState,
  )
  return [state, setState]
};
```






---
export default Layout

# Et moi demain ‚ÄΩ
* Attendre un peu une fois que ce sera sorti
* Ce sera le moment de faire de la veille et de laisser les furieux se casser les dents
* Ensuite, ce sera le moment de se d√©barasser des _mixins_
* Dans la mesure du possible coder les nouveaux composants avec les _hooks_
* Quelques mois plus tard, migrer les composants

---
export default Layout

# React 16.8 : Q2 2019
* `<React.Concurrent />`

---
export default Layout

# Et moi demain ‚ÄΩ
* √ätre bien pr√©par√©(e) pour les m√©thodes d√©pr√©ci√©es
* Savoir distinguer 2 types de priorit√©s : normale ou li√©e √† une action de l‚Äôutilisateur (click)

---
export default Layout

# React 16.9 : mi-2019
* `React.Cache`

---
export default Layout

# Et moi demain ‚ÄΩ
* _A priori_ rien, ce sera surtout pour les fournisseurs de librairies : Apollo, Relay, ‚Ä¶

---
export default Layout

# Courant 2019
* `React.DOM` modernis√©
* `<Suspense />` c√¥t√© serveur

---
export default Layout

# React ‚Ä¶ 17 ?
* async/concurrent par d√©faut
* m√©thodes d√©pr√©ci√©es recal√©es en `unstable_`
* `</class>`

---
# Q & R